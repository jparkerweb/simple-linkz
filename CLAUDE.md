# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

**Development:**
```bash
npm run build:css      # Build Tailwind CSS (minified)
npm run watch:css      # Watch and rebuild CSS on changes
npm start              # Start Node.js server (port 3000)
npm run dev            # Build CSS then start server
```

**Docker:**
```bash
docker build -t simple-linkz .
docker run -p 3000:3000 -v ./data:/data simple-linkz
docker-compose up -d
```

## Architecture

Simple Linkz is a single-user, self-hosted link dashboard with minimal dependencies. It uses vanilla JavaScript on the frontend and native Node.js HTTP server on the backend (no Express).

### Backend Modules (src/)

**server.js** - HTTP server entry point
- Routes `/` and static files to `public/`
- Routes `/api/*` to `api.js`
- Serves on port 3000 (configurable via `PORT` env var)
- **BASE_PATH Support**:
  - Strips `BASE_PATH` prefix from incoming requests (server.js:65-68)
  - Rewrites asset URLs in HTML to include `BASE_PATH` (server.js:43-46)
  - Injects `window.BASE_PATH` variable into HTML (server.js:40)

**storage.js** - JSON file persistence layer
- All data stored in single file: `/data/data.json`
- Provides atomic writes using temp file + rename pattern
- Functions: `initializeData()`, `readData()`, `writeData()`, getters/setters for user, links, preferences, sessions

**auth.js** - Authentication and session management
- Bcrypt password hashing (10 rounds)
- HMAC-SHA256 signed cookies
- 7-day session expiration
- Functions: `hashPassword()`, `verifyPassword()`, `signCookie()`, `verifyCookie()`, `createSession()`, `isSessionValid()`

**api.js** - API endpoint router
- Handles all `/api/*` endpoints
- Auth middleware checks signed session cookie
- Endpoints: setup, login, logout, links, preferences, import/export, favicon proxy

### Frontend (public/)

**index.html** - SPA structure with three screens:
- Setup screen (first-run user creation)
- Login screen
- Dashboard (header, links container, modals)

**app.js** - Vanilla JavaScript SPA logic
- State management: `{ links, preferences, searchQuery, editingLink }`
- API client wrapper functions
- Dynamic rendering based on layout (grid/list/cards)
- Drag-and-drop reordering
- Modal management (link CRUD, settings)
- **BASE_PATH Support**: Reads `window.BASE_PATH` and prepends to all API calls (app.js:2, 15+)

**styles.css** - Generated by Tailwind CLI (do not edit directly)

**input.css** (in src/) - Tailwind source with `@tailwind` directives

### Data Schema

**data.json structure:**
```json
{
  "sessionSecret": "auto-generated-hex",
  "user": {
    "username": "admin",
    "passwordHash": "$2a$10$..."
  },
  "preferences": {
    "layout": "grid|list|cards",
    "theme": "light|dark",
    "accentColor": "blue|green|purple|red|orange",
    "backgroundColor": "white|gray|slate|zinc|dark",
    "pageTitle": "Simple Linkz"
  },
  "links": [
    {
      "id": "uuid-v4",
      "name": "Name (with emoji support)",
      "url": "https://...",
      "order": 0,
      "faviconUrl": "https://..."
    }
  ],
  "sessions": {
    "token": {
      "createdAt": 1234567890,
      "expiresAt": 1234567890
    }
  }
}
```

### Key Design Patterns

**Modular Backend**: Clean separation of concerns (storage, auth, API, server)

**No Framework**: Uses native Node.js HTTP module, native `fs`, `crypto`, `path`, `https`

**Atomic Writes**: Storage writes to temp file then renames to avoid corruption

**Signed Cookies**: Sessions use HMAC-SHA256 signatures to prevent tampering

**Auto-Generated Secrets**: Session secret auto-generated on first run and persisted

**Favicon Proxy**: `/api/favicon` endpoint proxies favicon fetches to avoid CORS issues in browser

**Base Path Support**: Optional `BASE_PATH` environment variable allows serving from subpaths (e.g., `/simple-linkz`) behind reverse proxies, similar to Sonarr/Radarr URL base configuration

## Environment Variables

- `PORT` - Server port (default: 3000)
- `SESSION_SECRET` - Custom session secret (auto-generated if not provided)
- `DATA_DIR` - Custom data directory path (default: ./data)
- `BASE_PATH` - Base URL path for reverse proxy subpath serving (default: empty/root)
  - Example: `BASE_PATH=/simple-linkz` for serving at `yourdomain.com/simple-linkz`
  - Server strips this prefix from incoming requests
  - Automatically injects `window.BASE_PATH` into frontend HTML
  - Leave empty to serve from root

## Important Notes

**Data Persistence**:
- All data in `/data/data.json` (git-ignored)
- Docker volume mount required: `-v ./data:/data`

**Password Reset**:
- Stop server
- Edit `data/data.json` and delete entire `"user"` object
- Restart server â†’ setup screen appears

**CSS Changes**:
- Edit `src/input.css` (Tailwind source)
- Run `npm run build:css` to regenerate `public/styles.css`
- Never edit `public/styles.css` directly

**Security**:
- Single-user design (no multi-user support)
- HttpOnly, SameSite=Strict cookies
- Bcrypt password hashing
- Session expiration checked on each request

**Additional Features** (beyond original SOW):
- Custom page title editing
- Background color customization (theme-specific palettes)
- Automatic favicon fetching when saving links
- Reverse proxy subpath support (BASE_PATH)

**Reverse Proxy / Subpath Serving**:
- Set `BASE_PATH=/your-path` environment variable
- Example: `BASE_PATH=/links` allows serving at `yourdomain.com/links`
- Works like Sonarr/Radarr URL base configuration
- No additional nginx rewrite rules needed
- Server handles all path stripping and URL rewriting automatically
- Frontend automatically adjusts all asset and API URLs
